(()=>{"use strict";window.util={generateRandom:function(e,t){return Math.floor(Math.random()*(t-e))+e},getNumberValueFromStrPX:function(e){return+e.substring(0,e.length-2)}},(()=>{function e(e,t,n,o){const r=new XMLHttpRequest;r.timeout=1e4,r.responseType="json","GET"===n?r.open("GET","https://21.javascript.pages.academy/keksobooking/data"):r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.addEventListener("load",(function(){switch(r.status){case 200:e(r.response);break;default:t("Status code is "+r.status)}})),r.addEventListener("error",(function(){t("Connection error")})),r.addEventListener("timeout",(function(){t("Timout error")})),o?r.send(o):r.send()}window.ajax={getData:function(t,n){e(t,n,"GET")},sendData:function(t,n,o){e(t,n,"POST",o)}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__filters-container"),t=document.querySelector("#card").content.querySelector(".map__card");let n;function o(){n&&(n.remove(),document.removeEventListener("keydown",r))}function r(e){"Escape"===e.key&&o()}window.card={locateData:function(a=window.data.ads[0]){o(),function(e){n=t.cloneNode(!0),n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=window.data.types[e.offer.type],n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,function(e){const t=n.querySelector(".popup__features"),o=[...t.children];for(let n of o){const o=n.classList[1].split("--")[1];-1===e.offer.features.indexOf(o)&&t.removeChild(n)}}(e),n.querySelector(".popup__description").textContent=e.offer.description,function(e){const t=n.querySelector(".popup__photos"),o=document.createDocumentFragment(),r=t.children[0];for(let t of e.offer.photos){const e=r.cloneNode(!0);e.src=t,o.appendChild(e)}r.remove(),t.appendChild(o)}(e),n.querySelector(".popup__avatar").src=e.author.avatar}(a),e.insertAdjacentElement("beforebegin",n),n.querySelector(".popup__close").addEventListener("click",(function(){o()})),document.addEventListener("keydown",r)},close:o}})(),(()=>{const e={defaultX:570,defaultY:375,width:62,height:62,heightWithPin:84,getInactiveY(){return window.util.getNumberValueFromStrPX(window.pin.main.style.top)+this.height/2},getActiveY(){return window.util.getNumberValueFromStrPX(window.pin.main.style.top)+this.heightWithPin/2},getX(){return window.util.getNumberValueFromStrPX(window.pin.main.style.left)+this.width/2}},t=document.querySelector(".map"),n=t.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),r=t.querySelector("#housing-type"),a=t.querySelector("#housing-price"),i=t.querySelector("#housing-rooms"),c=t.querySelector("#housing-guests"),d=t.querySelector("#housing-features"),s=document.querySelector("#pin").content.querySelector(".map__pin");let u;function l(e){const t=s.cloneNode(!0),n=t.querySelector("img");return t.dataset.id||(t.dataset.id=e.id),t.style.left=e.location.x+"px",t.style.top=e.location.y+"px",n.src=e.author.avatar,n.alt=e.offer.title,t}function m(e){const t=e.target.closest(".map__pin[type=button]");t&&window.card.locateData(window.data.ads[t.dataset.id])}function p(e){const t=e.target.closest(".map__pin[type=button]");"Enter"===e.key&&t&&window.card.locateData(window.data.ads[t.dataset.id])}function f(){window.map.removeData(),n.removeEventListener("click",m),n.removeEventListener("keydown",p);const e=function(){let e=window.data.ads;const t=r.value;"any"!==t&&(e=e.filter((e=>e.offer.type===t)));const n=a.value;"any"!==n&&(e=e.filter((e=>({middle:e=>e>=1e4&&e<5e4,low:e=>e<1e4,high:e=>e>=5e4}[n](e.offer.price)))));const o=i.value;"any"!==o&&(e=e.filter((e=>e.offer.rooms===+o)));const s=c.value;"any"!==s&&(e=e.filter((e=>e.offer.guests===+s)));const u=Array.from(d.querySelectorAll(".map__checkbox")).filter((e=>e.checked)).map((e=>e.value));return u.length>0&&(e=e.filter((e=>u.every((t=>-1!==e.offer.features.indexOf(t)))))),e}(),t=document.createDocumentFragment(),o=e.length>5?5:e.length;for(let n=0;n<o;n++){const o=l(e[n]);t.appendChild(o)}n.appendChild(t),n.addEventListener("click",m),n.addEventListener("keydown",p)}function v(e){0===e.button&&window.page.activation()}function w(e){"Enter"===e.key&&window.page.activation()}function y(e){const t=window.util.getNumberValueFromStrPX(o.style.left),n=window.util.getNumberValueFromStrPX(o.style.top);let r=t+e.movementX;r<250?r=250:r>1140&&(r=1140),o.style.left=r+"px";let a=n+e.movementY;a<130?a=130:a>630&&(a=630),o.style.top=a+"px",window.form.setAddressField()}function g(){document.addEventListener("mousemove",y),document.addEventListener("mouseup",h)}function h(){document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",h)}function E(e){u&&window.clearTimeout(u),u=setTimeout((function(){e()}),500)}window.pin={main:o,mainData:e,activation:function(){o.removeEventListener("mousedown",v),o.removeEventListener("keydown",w),o.addEventListener("mousedown",g),r.addEventListener("change",(()=>E(f))),a.addEventListener("change",(()=>E(f))),i.addEventListener("change",(()=>E(f))),c.addEventListener("change",(()=>E(f))),d.addEventListener("change",(()=>E(f)))},deactivation:function(){o.addEventListener("mousedown",v),o.addEventListener("keydown",w),o.removeEventListener("mousedown",g),r.removeEventListener("change",(()=>E(f))),a.removeEventListener("change",(()=>E(f))),i.removeEventListener("change",(()=>E(f))),c.removeEventListener("change",(()=>E(f))),d.removeEventListener("change",(()=>E(f))),o.style.left=window.pin.mainData.defaultX+"px",o.style.top=window.pin.mainData.defaultY+"px"},locateData:f}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters");function n(e){window.data.ads||(window.data.ads=e);for(let t=0;t<e.length;t++)e[t].id=t;window.pin.locateData(),window.card.locateData()}function o(){const e=document.querySelector(".map__card");e&&e.remove(),document.querySelectorAll(".map__pin[type=button]").forEach((e=>e.remove()))}window.map={activation:function(){e.classList.remove("map--faded");for(let e of t.children)e.disabled=!1;window.data.ads?n(window.data.ads):window.ajax.getData(n,window.page.errorMsg)},deactivation:function(){e.classList.add("map--faded");for(let e of t.children)e.disabled=!0;o()},removeData:o}})(),(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t=document.querySelector(".ad-form"),n=t.querySelector("#room_number"),o=t.querySelector("#capacity"),r=t.querySelector("#timein"),a=t.querySelector("#timeout"),i=t.querySelector("#type"),c=t.querySelector("#price"),d=t.querySelector("#address"),s=t.querySelector(".ad-form__reset"),u=t.querySelector("#avatar"),l=t.querySelector(".ad-form-header__preview img"),m=t.querySelector("#images"),p=t.querySelector(".ad-form__photo");function f(e){const t=+n.value,r=+o.value;let a="";return 100===t&&0!==r||0===r&&100!==t?a="Для такого варианта доступно соответствие '100 комнат' и 'не для гостей'":t<r&&(a="Каждая комната не больше 1 гостя, выберите более просторный вариант"),a&&e.preventDefault(),n.setCustomValidity(a),n.reportValidity(),Boolean(!a)}function v(e){if(f(e)){e.preventDefault();const n=new FormData(t);n.append("address",d.value),window.ajax.sendData(window.page.onSuccess,window.page.onError,n),window.page.deactivation()}}function w(){a.querySelector(`option[value="${r.value}"]`).selected=!0}function y(){r.querySelector(`option[value="${a.value}"]`).selected=!0}function g(){const t=e[i.value];c.min=t,c.placeholder=t}function h(){const e=new FileReader;e.addEventListener("load",(function(){l.src=e.result})),e.readAsDataURL(u.files[0])}function E(){const e=new FileReader;e.addEventListener("load",(function(){p.style.backgroundImage=`url(${e.result})`,p.style.backgroundSize="cover",p.style.backgroundPosition="center"})),e.readAsDataURL(m.files[0])}function L(){const e=window.page.isActive()?window.pin.mainData.getActiveY():window.pin.mainData.getInactiveY(),t=window.pin.mainData.getX();d.value=`${t}, ${e}`}d.disabled=!0,window.form={activation:function(){t.classList.remove("ad-form--disabled"),n.addEventListener("change",f),o.addEventListener("change",f),t.addEventListener("submit",v),r.addEventListener("change",w),a.addEventListener("change",y),i.addEventListener("change",g),s.addEventListener("click",window.page.deactivation),u.addEventListener("change",h),m.addEventListener("change",E);for(let e of t.children)e.disabled=!1;L()},deactivation:function(){t.classList.add("ad-form--disabled"),n.removeEventListener("change",f),o.removeEventListener("change",f),t.removeEventListener("submit",v),r.removeEventListener("change",w),a.removeEventListener("change",y),i.removeEventListener("change",g),s.removeEventListener("click",window.page.deactivation),u.removeEventListener("change",h),m.removeEventListener("change",E);for(let e of t.children)e.disabled=!0;t.reset(),L()},setAddressField:L}})(),window.data={ads:void 0,types:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"}},(()=>{const e=document.querySelector("#success").content,t=document.querySelector("#error").content;let n=!1;window.page={isActive:function(){return n},activation:function(){n=!0,window.pin.activation(),window.map.activation(),window.form.activation()},deactivation:function(){n=!1,window.pin.deactivation(),window.map.deactivation(),window.form.deactivation()},errorMsg:function(e){const t=document.createElement("div");t.append(e),t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.padding="50px 100px",t.style.width="500px",t.style.minHeight="200px",t.style.color="white",t.style.backgroundColor="#c000ff",t.style.boxShadow="0 0 10px 5px black",t.style.transform="translate(-50%, -50%)",t.style.zIndex="100",document.querySelector("body").appendChild(t)},onSuccess:function(){function t(){document.querySelector(".success").remove(),document.removeEventListener("click",t),document.removeEventListener("keydown",n)}function n(e){"Escape"===e.key&&t()}document.querySelector("main").appendChild(e.cloneNode(!0)),document.addEventListener("click",t),document.addEventListener("keydown",n)},onError:function(){const e=t.cloneNode(!0),n=e.querySelector(".error__button");function o(){document.querySelector(".error").remove(),document.removeEventListener("click",o),document.removeEventListener("keydown",r),n.removeEventListener("click",o)}function r(e){"Escape"===e.key&&o()}document.querySelector("main").appendChild(e),n.addEventListener("click",o),document.addEventListener("click",o),document.addEventListener("keydown",r)}}})(),window.page.deactivation()})();