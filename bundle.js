(()=>{"use strict";(()=>{let e;window.util={generateRandom:function(e,t){return Math.floor(Math.random()*(t-e))+e},getNumberValueFromStrPX:function(e){return+e.substring(0,e.length-2)},debounce:function(t){e&&window.clearTimeout(e),e=setTimeout((function(){t()}),500)}}})(),window.data={ads:void 0,types:{PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом",BUNGALOW:"Бунгало"}},(()=>{function e(e,t,n,o){const i=new XMLHttpRequest;i.timeout=1e4,i.responseType="json","GET"===n?i.open("GET","https://21.javascript.pages.academy/keksobooking/data"):i.open("POST","https://21.javascript.pages.academy/keksobooking"),i.addEventListener("load",(()=>{switch(i.status){case 200:e(i.response);break;default:t("Status code is "+i.status)}})),i.addEventListener("error",(()=>t("Connection error"))),i.addEventListener("timeout",(()=>t("Timout error"))),o?i.send(o):i.send()}window.ajax={getData:function(t,n){e(t,n,"GET")},sendData:function(t,n,o){e(t,n,"POST",o)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters");function n(e){window.data.ads||(window.data.ads=e);for(let t=0;t<e.length;t++)e[t].id=t;window.pin.locateData()}function o(){const e=document.querySelector(".map__card");e&&e.remove(),document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove()))}window.map={domElement:e,activation:function(){e.classList.remove("map--faded");for(let e of t.children)e.disabled=!1;window.data.ads?n(window.data.ads):window.ajax.getData(n,window.page.errorMsg)},deactivation:function(){e.classList.add("map--faded");for(let e of t.children)e.disabled=!0;o(),t.reset()},removeData:o}})(),(()=>{const e=window.map.domElement.querySelector(".map__filters-container"),t=document.querySelector("#card").content.querySelector(".map__card");let n;function o(){n&&(n.remove(),document.removeEventListener("keydown",i))}function i(e){"Escape"===e.key&&o()}window.card={locateData:function(r=window.data.ads[0]){o(),function(e){n=t.cloneNode(!0),n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=window.data.types[e.offer.type.toUpperCase()],n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,function(e){const t=n.querySelector(".popup__features"),o=[...t.children];for(let n of o){const o=n.classList[1].split("--")[1];-1===e.offer.features.indexOf(o)&&t.removeChild(n)}}(e),n.querySelector(".popup__description").textContent=e.offer.description,function(e){const t=n.querySelector(".popup__photos"),o=document.createDocumentFragment(),i=t.children[0];for(let t of e.offer.photos){const e=i.cloneNode(!0);e.src=t,o.appendChild(e)}i.remove(),t.appendChild(o)}(e),n.querySelector(".popup__avatar").src=e.author.avatar}(r),e.insertAdjacentElement("beforebegin",n),n.querySelector(".popup__close").addEventListener("click",o),document.addEventListener("keydown",i)},close:o}})(),(()=>{const e="any",t={defaultX:570,defaultY:375,width:62,height:62,heightWithPin:84,getInactiveY(){return window.util.getNumberValueFromStrPX(window.pin.main.style.top)+this.height/2},getActiveY(){return window.util.getNumberValueFromStrPX(window.pin.main.style.top)+this.heightWithPin/2},getX(){return window.util.getNumberValueFromStrPX(window.pin.main.style.left)+this.width/2}},n=window.map.domElement.querySelector(".map__pins"),o=window.map.domElement.querySelector(".map__pin--main"),i=window.map.domElement.querySelector("#housing-type"),r=window.map.domElement.querySelector("#housing-price"),a=window.map.domElement.querySelector("#housing-rooms"),d=window.map.domElement.querySelector("#housing-guests"),c=window.map.domElement.querySelector("#housing-features"),s=document.querySelector("#pin").content.querySelector(".map__pin");function u(e){const t=s.cloneNode(!0),n=t.querySelector("img");return t.dataset.id||(t.dataset.id=e.id),t.style.left=e.location.x+"px",t.style.top=e.location.y+"px",n.src=e.author.avatar,n.alt=e.offer.title,t}function l(){window.map.removeData();const t=function(){let t=window.data.ads;const n=i.value;n!==e&&(t=t.filter((e=>e.offer.type===n)));const o=r.value;o!==e&&(t=t.filter((e=>({low:e=>e<1e4,middle:e=>e>=1e4&&e<5e4,high:e=>e>=5e4}[o](e.offer.price)))));const s=a.value;s!==e&&(t=t.filter((e=>e.offer.rooms===+s)));const u=d.value;u!==e&&(t=t.filter((e=>e.offer.guests===+u)));const l=Array.from(c.querySelectorAll(".map__checkbox:checked")).map((e=>e.value));return l.length>0&&(t=t.filter((e=>l.every((t=>-1!==e.offer.features.indexOf(t)))))),t}(),o=document.createDocumentFragment(),s=t.length>5?5:t.length;for(let e=0;e<s;e++){const n=u(t[e]);o.appendChild(n)}n.appendChild(o)}function p(){document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",p)}function m(e){const t=window.util.getNumberValueFromStrPX(o.style.left),n=window.util.getNumberValueFromStrPX(o.style.top);let i=t+e.movementX;i<0?i=0:i>1140&&(i=1140),o.style.left=i+"px";let r=n+e.movementY;r<88?r=88:r>588&&(r=588),o.style.top=r+"px",window.form.setAddressField()}o.addEventListener("mousedown",(function(e){0===e.button&&window.page.activation(),document.addEventListener("mousemove",m),document.addEventListener("mouseup",p)})),o.addEventListener("keydown",(function(e){"Enter"===e.key&&window.page.activation()})),n.addEventListener("click",(function(e){const t=e.target.closest(".map__pin[type=button]");t&&window.card.locateData(window.data.ads[t.dataset.id])})),n.addEventListener("keydown",(function(e){const t=e.target.closest(".map__pin[type=button]");"Enter"===e.key&&t&&window.card.locateData(window.data.ads[t.dataset.id])})),i.addEventListener("change",(()=>window.util.debounce(l))),r.addEventListener("change",(()=>window.util.debounce(l))),a.addEventListener("change",(()=>window.util.debounce(l))),d.addEventListener("change",(()=>window.util.debounce(l))),c.addEventListener("change",(()=>window.util.debounce(l))),window.pin={main:o,mainData:t,setMainToDefaultState:function(){o.style.left=window.pin.mainData.defaultX+"px",o.style.top=window.pin.mainData.defaultY+"px"},locateData:l}})(),(()=>{const e=["gif","jpg","jpeg","png","jfif"],t={BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},n=document.querySelector(".ad-form"),o=n.querySelector("#room_number"),i=n.querySelector("#capacity"),r=n.querySelector("#timein"),a=n.querySelector("#timeout"),d=n.querySelector("#type"),c=n.querySelector("#price"),s=n.querySelector("#address"),u=n.querySelector(".ad-form__reset"),l=n.querySelector("#avatar"),p=n.querySelector(".ad-form-header__preview img"),m=n.querySelector("#images"),f=n.querySelector(".ad-form__photo");function w(e){const t=+o.value,n=+i.value;let r="";return 100===t&&0!==n||0===n&&100!==t?r="Для такого варианта доступно соответствие '100 комнат' и 'не для гостей'":t<n&&(r="Каждая комната не больше 1 гостя, выберите более просторный вариант"),r&&e.preventDefault(),o.setCustomValidity(r),o.reportValidity(),Boolean(!r)}function y(){const e=t[d.value.toUpperCase()];c.min=e,c.placeholder=e}function v(t){const n=t.name.toLowerCase();return e.some((e=>n.endsWith(e)))}function g(){const e=window.page.isActive()?window.pin.mainData.getActiveY():window.pin.mainData.getInactiveY(),t=window.pin.mainData.getX();s.value=`${t}, ${e}`}s.readOnly=!0,o.addEventListener("change",w),i.addEventListener("change",w),n.addEventListener("submit",(function(e){w(e)&&(e.preventDefault(),window.ajax.sendData(window.page.onSuccess,window.page.onError,new FormData(n)),window.page.deactivation())})),r.addEventListener("change",(function(){a.querySelector(`option[value="${r.value}"]`).selected=!0})),a.addEventListener("change",(function(){r.querySelector(`option[value="${a.value}"]`).selected=!0})),d.addEventListener("change",y),u.addEventListener("click",(function(){window.page.deactivation()})),l.addEventListener("change",(function(){const e=l.files[0];if(v(e)){const t=new FileReader;t.addEventListener("load",(()=>{p.src=t.result})),t.readAsDataURL(e)}})),m.addEventListener("change",(function(){const e=m.files[0];if(v(e)){const t=new FileReader;t.addEventListener("load",(()=>{f.style.backgroundImage=`url(${t.result})`,f.style.backgroundSize="cover",f.style.backgroundPosition="center"})),t.readAsDataURL(e)}})),window.form={activation:function(){n.classList.remove("ad-form--disabled");for(let e of n.children)e.disabled=!1;g()},deactivation:function(){n.classList.add("ad-form--disabled");for(let e of n.children)e.disabled=!0;n.reset(),g(),p.src="img/muffin-grey.svg",f.style.backgroundImage="",y()},setAddressField:g}})(),(()=>{const e=document.querySelector("body"),t=e.querySelector("main"),n=e.querySelector("#success").content,o=e.querySelector("#error").content;let i=!1;function r(){i=!1,window.pin.setMainToDefaultState(),window.map.deactivation(),window.form.deactivation()}window.page={isActive:function(){return i},activation:function(){i||(i=!0,window.map.activation(),window.form.activation())},deactivation:r,errorMsg:function(t){const n=document.createElement("div");n.append(t),n.style.position="fixed",n.style.top="50%",n.style.left="50%",n.style.padding="50px 100px",n.style.width="500px",n.style.minHeight="200px",n.style.color="white",n.style.backgroundColor="#c000ff",n.style.boxShadow="0 0 10px 5px black",n.style.transform="translate(-50%, -50%)",n.style.zIndex="100",e.appendChild(n)},onSuccess:function(){function e(){document.querySelector(".success").remove(),document.removeEventListener("click",e),document.removeEventListener("keydown",o)}function o(t){"Escape"===t.key&&e()}t.appendChild(n.cloneNode(!0)),document.addEventListener("click",e),document.addEventListener("keydown",o)},onError:function(){const e=o.cloneNode(!0),n=e.querySelector(".error__button");function i(){document.querySelector(".error").remove(),document.removeEventListener("click",i),document.removeEventListener("keydown",r),n.removeEventListener("click",i)}function r(e){"Escape"===e.key&&i()}t.appendChild(e),n.addEventListener("click",i),document.addEventListener("click",i),document.addEventListener("keydown",r)},setFlag:function(e){i=e}},r()})()})();