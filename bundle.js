(()=>{"use strict";(()=>{let e;window.util={generateRandom:function(e,t){return Math.floor(Math.random()*(t-e))+e},getNumberValueFromStrPX:function(e){return+e.substring(0,e.length-2)},debounce:function(t){e&&window.clearTimeout(e),e=setTimeout((function(){t()}),500)}}})(),window.data={ads:void 0,types:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"}},(()=>{function e(e,t,n,o){const i=new XMLHttpRequest;i.timeout=1e4,i.responseType="json","GET"===n?i.open("GET","https://21.javascript.pages.academy/keksobooking/data"):i.open("POST","https://21.javascript.pages.academy/keksobooking"),i.addEventListener("load",(function(){switch(i.status){case 200:e(i.response);break;default:t("Status code is "+i.status)}})),i.addEventListener("error",(function(){t("Connection error")})),i.addEventListener("timeout",(function(){t("Timout error")})),o?i.send(o):i.send()}window.ajax={getData:function(t,n){e(t,n,"GET")},sendData:function(t,n,o){e(t,n,"POST",o)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters");function n(e){window.data.ads||(window.data.ads=e);for(let t=0;t<e.length;t++)e[t].id=t;window.pin.locateData()}function o(){const e=document.querySelector(".map__card");e&&e.remove(),document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove()))}window.map={domElement:e,activation:function(){e.classList.remove("map--faded");for(let e of t.children)e.disabled=!1;window.data.ads?n(window.data.ads):window.ajax.getData(n,window.page.errorMsg)},deactivation:function(){e.classList.add("map--faded");for(let e of t.children)e.disabled=!0;o(),t.reset()},removeData:o}})(),(()=>{const e=window.map.domElement.querySelector(".map__filters-container"),t=document.querySelector("#card").content.querySelector(".map__card");let n;function o(){n&&(n.remove(),document.removeEventListener("keydown",i))}function i(e){"Escape"===e.key&&o()}window.card={locateData:function(a=window.data.ads[0]){o(),function(e){n=t.cloneNode(!0),n.querySelector(".popup__title").textContent=e.offer.title,n.querySelector(".popup__text--address").textContent=e.offer.address,n.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=window.data.types[e.offer.type],n.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,n.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,function(e){const t=n.querySelector(".popup__features"),o=[...t.children];for(let n of o){const o=n.classList[1].split("--")[1];-1===e.offer.features.indexOf(o)&&t.removeChild(n)}}(e),n.querySelector(".popup__description").textContent=e.offer.description,function(e){const t=n.querySelector(".popup__photos"),o=document.createDocumentFragment(),i=t.children[0];for(let t of e.offer.photos){const e=i.cloneNode(!0);e.src=t,o.appendChild(e)}i.remove(),t.appendChild(o)}(e),n.querySelector(".popup__avatar").src=e.author.avatar}(a),e.insertAdjacentElement("beforebegin",n),n.querySelector(".popup__close").addEventListener("click",(function(){o()})),document.addEventListener("keydown",i)},close:o}})(),(()=>{const e="any",t={defaultX:570,defaultY:375,width:62,height:62,heightWithPin:84,getInactiveY(){return window.util.getNumberValueFromStrPX(window.pin.main.style.top)+this.height/2},getActiveY(){return window.util.getNumberValueFromStrPX(window.pin.main.style.top)+this.heightWithPin/2},getX(){return window.util.getNumberValueFromStrPX(window.pin.main.style.left)+this.width/2}},n=window.map.domElement.querySelector(".map__pins"),o=window.map.domElement.querySelector(".map__pin--main"),i=window.map.domElement.querySelector("#housing-type"),a=window.map.domElement.querySelector("#housing-price"),r=window.map.domElement.querySelector("#housing-rooms"),d=window.map.domElement.querySelector("#housing-guests"),c=window.map.domElement.querySelector("#housing-features"),u=document.querySelector("#pin").content.querySelector(".map__pin");function s(e){const t=u.cloneNode(!0),n=t.querySelector("img");return t.dataset.id||(t.dataset.id=e.id),t.style.left=e.location.x+"px",t.style.top=e.location.y+"px",n.src=e.author.avatar,n.alt=e.offer.title,t}function l(){window.map.removeData();const t=function(){let t=window.data.ads;const n=i.value;n!==e&&(t=t.filter((e=>e.offer.type===n)));const o=a.value;o!==e&&(t=t.filter((e=>({low:e=>e<1e4,middle:e=>e>=1e4&&e<5e4,high:e=>e>=5e4}[o](e.offer.price)))));const u=r.value;u!==e&&(t=t.filter((e=>e.offer.rooms===+u)));const s=d.value;s!==e&&(t=t.filter((e=>e.offer.guests===+s)));const l=Array.from(c.querySelectorAll(".map__checkbox:checked")).map((e=>e.value));return l.length>0&&(t=t.filter((e=>l.every((t=>-1!==e.offer.features.indexOf(t)))))),t}(),o=document.createDocumentFragment(),u=t.length>5?5:t.length;for(let e=0;e<u;e++){const n=s(t[e]);o.appendChild(n)}n.appendChild(o)}function m(){document.removeEventListener("mousemove",p),document.removeEventListener("mouseup",m)}function p(e){const t=window.util.getNumberValueFromStrPX(o.style.left),n=window.util.getNumberValueFromStrPX(o.style.top);let i=t+e.movementX;i<0?i=0:i>1140&&(i=1140),o.style.left=i+"px";let a=n+e.movementY;a<88?a=88:a>588&&(a=588),o.style.top=a+"px",window.form.setAddressField()}o.addEventListener("mousedown",(function(e){0===e.button&&window.page.activation(),document.addEventListener("mousemove",p),document.addEventListener("mouseup",m)})),o.addEventListener("keydown",(function(e){"Enter"===e.key&&window.page.activation()})),n.addEventListener("click",(function(e){const t=e.target.closest(".map__pin[type=button]");t&&window.card.locateData(window.data.ads[t.dataset.id])})),n.addEventListener("keydown",(function(e){const t=e.target.closest(".map__pin[type=button]");"Enter"===e.key&&t&&window.card.locateData(window.data.ads[t.dataset.id])})),i.addEventListener("change",(()=>window.util.debounce(l))),a.addEventListener("change",(()=>window.util.debounce(l))),r.addEventListener("change",(()=>window.util.debounce(l))),d.addEventListener("change",(()=>window.util.debounce(l))),c.addEventListener("change",(()=>window.util.debounce(l))),window.pin={main:o,mainData:t,setMainToDefaultState:function(){o.style.left=window.pin.mainData.defaultX+"px",o.style.top=window.pin.mainData.defaultY+"px"},locateData:l}})(),(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t=document.querySelector(".ad-form"),n=t.querySelector("#room_number"),o=t.querySelector("#capacity"),i=t.querySelector("#timein"),a=t.querySelector("#timeout"),r=t.querySelector("#type"),d=t.querySelector("#price"),c=t.querySelector("#address"),u=t.querySelector(".ad-form__reset"),s=t.querySelector("#avatar"),l=t.querySelector(".ad-form-header__preview img"),m=t.querySelector("#images"),p=t.querySelector(".ad-form__photo");function f(e){const t=+n.value,i=+o.value;let a="";return 100===t&&0!==i||0===i&&100!==t?a="Для такого варианта доступно соответствие '100 комнат' и 'не для гостей'":t<i&&(a="Каждая комната не больше 1 гостя, выберите более просторный вариант"),a&&e.preventDefault(),n.setCustomValidity(a),n.reportValidity(),Boolean(!a)}function w(){const t=e[r.value];d.min=t,d.placeholder=t}function y(){const e=window.page.isActive()?window.pin.mainData.getActiveY():window.pin.mainData.getInactiveY(),t=window.pin.mainData.getX();c.value=`${t}, ${e}`}function v(){l.src="img/muffin-grey.svg",p.style.backgroundImage=""}c.readOnly=!0,n.addEventListener("change",f),o.addEventListener("change",f),t.addEventListener("submit",(function(e){f(e)&&(e.preventDefault(),window.ajax.sendData(window.page.onSuccess,window.page.onError,new FormData(t)),window.page.deactivation())})),i.addEventListener("change",(function(){a.querySelector(`option[value="${i.value}"]`).selected=!0})),a.addEventListener("change",(function(){i.querySelector(`option[value="${a.value}"]`).selected=!0})),r.addEventListener("change",w),u.addEventListener("click",(function(){t.reset(),v(),w(),window.map.deactivation(),window.pin.setMainToDefaultState(),window.page.setFlag(!1),setTimeout((function(){y()}),0)})),s.addEventListener("change",(function(){const e=new FileReader;e.addEventListener("load",(function(){l.src=e.result})),e.readAsDataURL(s.files[0])})),m.addEventListener("change",(function(){const e=new FileReader;e.addEventListener("load",(function(){p.style.backgroundImage=`url(${e.result})`,p.style.backgroundSize="cover",p.style.backgroundPosition="center"})),e.readAsDataURL(m.files[0])})),window.form={activation:function(){t.classList.remove("ad-form--disabled");for(let e of t.children)e.disabled=!1;y()},deactivation:function(){t.classList.add("ad-form--disabled");for(let e of t.children)e.disabled=!0;t.reset(),y(),v()},setAddressField:y}})(),(()=>{const e=document.querySelector("body"),t=e.querySelector("main"),n=e.querySelector("#success").content,o=e.querySelector("#error").content;let i=!1;function a(){i=!1,window.pin.setMainToDefaultState(),window.map.deactivation(),window.form.deactivation()}window.page={isActive:function(){return i},activation:function(){i||(i=!0,window.map.activation(),window.form.activation())},deactivation:a,errorMsg:function(t){const n=document.createElement("div");n.append(t),n.style.position="fixed",n.style.top="50%",n.style.left="50%",n.style.padding="50px 100px",n.style.width="500px",n.style.minHeight="200px",n.style.color="white",n.style.backgroundColor="#c000ff",n.style.boxShadow="0 0 10px 5px black",n.style.transform="translate(-50%, -50%)",n.style.zIndex="100",e.appendChild(n)},onSuccess:function(){function e(){document.querySelector(".success").remove(),document.removeEventListener("click",e),document.removeEventListener("keydown",o)}function o(t){"Escape"===t.key&&e()}t.appendChild(n.cloneNode(!0)),document.addEventListener("click",e),document.addEventListener("keydown",o)},onError:function(){const e=o.cloneNode(!0),n=e.querySelector(".error__button");function i(){document.querySelector(".error").remove(),document.removeEventListener("click",i),document.removeEventListener("keydown",a),n.removeEventListener("click",i)}function a(e){"Escape"===e.key&&i()}t.appendChild(e),n.addEventListener("click",i),document.addEventListener("click",i),document.addEventListener("keydown",a)},setFlag:function(e){i=e}},a()})()})();