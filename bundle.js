(()=>{"use strict";(()=>{let e;window.util={generateRandom:(e,t)=>Math.floor(Math.random()*(t-e))+e,getNumberValueFromStrPX:e=>+e.substring(0,e.length-2),debounce:t=>{e&&window.clearTimeout(e),e=setTimeout((()=>{t()}),500)}}})(),window.data={ads:void 0,types:{PALACE:"Дворец",FLAT:"Квартира",HOUSE:"Дом",BUNGALOW:"Бунгало"}},(()=>{const e=(e,t,o,n)=>{const a=new XMLHttpRequest;a.timeout=1e4,a.responseType="json","GET"===o?a.open("GET","https://21.javascript.pages.academy/keksobooking/data"):a.open("POST","https://21.javascript.pages.academy/keksobooking"),a.addEventListener("load",(()=>{switch(a.status){case 200:e(a.response);break;default:t("Status code is "+a.status)}})),a.addEventListener("error",(()=>t("Connection error"))),a.addEventListener("timeout",(()=>t("Timout error"))),n?a.send(n):a.send()};window.ajax={getData:(t,o)=>{e(t,o,"GET")},sendData:(t,o,n)=>{e(t,o,"POST",n)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters"),o=e=>{window.data.ads||(window.data.ads=e);for(let t=0;t<e.length;t++)e[t].id=t;window.pin.locateData()},n=()=>{const e=document.querySelector(".map__card");e&&e.remove(),document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove()))};window.map={domElement:e,activation:()=>{e.classList.remove("map--faded");for(let e of t.children)e.disabled=!1;window.data.ads?o(window.data.ads):window.ajax.getData(o,window.page.errorMsg)},deactivation:()=>{e.classList.add("map--faded");for(let e of t.children)e.disabled=!0;n(),t.reset()},removeData:n}})(),(()=>{const e=window.map.domElement.querySelector(".map__filters-container"),t=document.querySelector("#card").content.querySelector(".map__card");let o;const n=()=>{o&&(o.remove(),document.removeEventListener("keydown",a))},a=e=>{"Escape"===e.key&&n()};window.card={locateData:(r=window.data.ads[0])=>{n(),(e=>{o=t.cloneNode(!0),o.querySelector(".popup__title").textContent=e.offer.title,o.querySelector(".popup__text--address").textContent=e.offer.address,o.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",o.querySelector(".popup__type").textContent=window.data.types[e.offer.type.toUpperCase()],o.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,o.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,(e=>{const t=o.querySelector(".popup__features"),n=[...t.children];for(let o of n){const n=o.classList[1].split("--")[1];-1===e.offer.features.indexOf(n)&&t.removeChild(o)}})(e),o.querySelector(".popup__description").textContent=e.offer.description,(e=>{const t=o.querySelector(".popup__photos"),n=document.createDocumentFragment(),a=t.children[0];for(let t of e.offer.photos){const e=a.cloneNode(!0);e.src=t,n.appendChild(e)}a.remove(),t.appendChild(n)})(e),o.querySelector(".popup__avatar").src=e.author.avatar})(r),e.insertAdjacentElement("beforebegin",o),o.querySelector(".popup__close").addEventListener("click",n),document.addEventListener("keydown",a)},close:n}})(),(()=>{const e="any",t={defaultX:570,defaultY:375,width:62,height:62,heightWithPin:84,getInactiveY(){return window.util.getNumberValueFromStrPX(window.pin.main.style.top)+this.height/2},getActiveY(){return window.util.getNumberValueFromStrPX(window.pin.main.style.top)+this.heightWithPin/2},getX(){return window.util.getNumberValueFromStrPX(window.pin.main.style.left)+this.width/2}},o=window.map.domElement.querySelector(".map__pins"),n=window.map.domElement.querySelector(".map__pin--main"),a=window.map.domElement.querySelector("#housing-type"),r=window.map.domElement.querySelector("#housing-price"),d=window.map.domElement.querySelector("#housing-rooms"),i=window.map.domElement.querySelector("#housing-guests"),c=window.map.domElement.querySelector("#housing-features"),s=document.querySelector("#pin").content.querySelector(".map__pin"),l=e=>{const t=s.cloneNode(!0),o=t.querySelector("img");return t.dataset.id||(t.dataset.id=e.id),t.style.left=e.location.x+"px",t.style.top=e.location.y+"px",o.src=e.author.avatar,o.alt=e.offer.title,t},u=()=>{window.map.removeData();const t=(()=>{let t=window.data.ads;const o=a.value;o!==e&&(t=t.filter((e=>e.offer.type===o)));const n=r.value;n!==e&&(t=t.filter((e=>({low:e=>e<1e4,middle:e=>e>=1e4&&e<5e4,high:e=>e>=5e4}[n](e.offer.price)))));const s=d.value;s!==e&&(t=t.filter((e=>e.offer.rooms===+s)));const l=i.value;l!==e&&(t=t.filter((e=>e.offer.guests===+l)));const u=Array.from(c.querySelectorAll(".map__checkbox:checked")).map((e=>e.value));return u.length>0&&(t=t.filter((e=>u.every((t=>-1!==e.offer.features.indexOf(t)))))),t})(),n=document.createDocumentFragment(),s=t.length>5?5:t.length;for(let e=0;e<s;e++){const o=l(t[e]);n.appendChild(o)}o.appendChild(n)},p=()=>{document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",p)},m=e=>{const t=window.util.getNumberValueFromStrPX(n.style.left),o=window.util.getNumberValueFromStrPX(n.style.top);let a=t+e.movementX;a<0?a=0:a>1140&&(a=1140),n.style.left=a+"px";let r=o+e.movementY;r<88?r=88:r>588&&(r=588),n.style.top=r+"px",window.form.setAddressField()};n.addEventListener("mousedown",(e=>{0===e.button&&window.page.activation(),document.addEventListener("mousemove",m),document.addEventListener("mouseup",p)})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&window.page.activation()})),o.addEventListener("click",(e=>{const t=e.target.closest(".map__pin[type=button]");t&&window.card.locateData(window.data.ads[t.dataset.id])})),o.addEventListener("keydown",(e=>{const t=e.target.closest(".map__pin[type=button]");"Enter"===e.key&&t&&window.card.locateData(window.data.ads[t.dataset.id])})),a.addEventListener("change",(()=>window.util.debounce(u))),r.addEventListener("change",(()=>window.util.debounce(u))),d.addEventListener("change",(()=>window.util.debounce(u))),i.addEventListener("change",(()=>window.util.debounce(u))),c.addEventListener("change",(()=>window.util.debounce(u))),window.pin={main:n,mainData:t,setMainToDefaultState:()=>{n.style.left=window.pin.mainData.defaultX+"px",n.style.top=window.pin.mainData.defaultY+"px"},locateData:u}})(),(()=>{const e=["gif","jpg","jpeg","png","jfif"],t={BUNGALOW:0,FLAT:1e3,HOUSE:5e3,PALACE:1e4},o=document.querySelector(".ad-form"),n=o.querySelector("#room_number"),a=o.querySelector("#capacity"),r=o.querySelector("#timein"),d=o.querySelector("#timeout"),i=o.querySelector("#type"),c=o.querySelector("#price"),s=o.querySelector("#address"),l=o.querySelector(".ad-form__reset"),u=o.querySelector("#avatar"),p=o.querySelector(".ad-form-header__preview img"),m=o.querySelector("#images"),w=o.querySelector(".ad-form__photo");s.readOnly=!0;const y=e=>{const t=+n.value,o=+a.value;let r="";return 100===t&&0!==o||0===o&&100!==t?r="Для такого варианта доступно соответствие '100 комнат' и 'не для гостей'":t<o&&(r="Каждая комната не больше 1 гостя, выберите более просторный вариант"),r&&e.preventDefault(),n.setCustomValidity(r),n.reportValidity(),Boolean(!r)},v=()=>{const e=t[i.value.toUpperCase()];c.min=e,c.placeholder=e},f=t=>{const o=t.name.toLowerCase();return e.some((e=>o.endsWith(e)))},g=()=>{const e=window.page.isActive()?window.pin.mainData.getActiveY():window.pin.mainData.getInactiveY(),t=window.pin.mainData.getX();s.value=`${t}, ${e}`};n.addEventListener("change",y),a.addEventListener("change",y),o.addEventListener("submit",(e=>{y(e)&&(e.preventDefault(),window.ajax.sendData(window.page.onSuccess,window.page.onError,new FormData(o)),window.page.deactivation())})),r.addEventListener("change",(()=>{d.querySelector(`option[value="${r.value}"]`).selected=!0})),d.addEventListener("change",(()=>{r.querySelector(`option[value="${d.value}"]`).selected=!0})),i.addEventListener("change",v),l.addEventListener("click",(()=>{window.page.deactivation()})),u.addEventListener("change",(()=>{const e=u.files[0];if(f(e)){const t=new FileReader;t.addEventListener("load",(()=>{p.src=t.result})),t.readAsDataURL(e)}})),m.addEventListener("change",(()=>{const e=m.files[0];if(f(e)){const t=new FileReader;t.addEventListener("load",(()=>{w.style.backgroundImage=`url(${t.result})`,w.style.backgroundSize="cover",w.style.backgroundPosition="center"})),t.readAsDataURL(e)}})),window.form={activation:()=>{o.classList.remove("ad-form--disabled");for(let e of o.children)e.disabled=!1;g()},deactivation:()=>{o.classList.add("ad-form--disabled");for(let e of o.children)e.disabled=!0;o.reset(),g(),p.src="img/muffin-grey.svg",w.style.backgroundImage="",v()},setAddressField:g}})(),(()=>{const e=document.querySelector("body"),t=e.querySelector("main"),o=e.querySelector("#success").content,n=e.querySelector("#error").content;let a=!1;const r=()=>{a=!1,window.pin.setMainToDefaultState(),window.map.deactivation(),window.form.deactivation()};window.page={isActive:()=>a,activation:()=>{a||(a=!0,window.map.activation(),window.form.activation())},deactivation:r,errorMsg:t=>{const o=document.createElement("div");o.append(t),o.style.position="fixed",o.style.top="50%",o.style.left="50%",o.style.padding="50px 100px",o.style.width="500px",o.style.minHeight="200px",o.style.color="white",o.style.backgroundColor="#c000ff",o.style.boxShadow="0 0 10px 5px black",o.style.transform="translate(-50%, -50%)",o.style.zIndex="100",e.appendChild(o)},onSuccess:()=>{t.appendChild(o.cloneNode(!0));const e=()=>{document.querySelector(".success").remove(),document.removeEventListener("click",e),document.removeEventListener("keydown",n)},n=t=>{"Escape"===t.key&&e()};document.addEventListener("click",e),document.addEventListener("keydown",n)},onError:()=>{const e=n.cloneNode(!0),o=e.querySelector(".error__button");t.appendChild(e);const a=()=>{document.querySelector(".error").remove(),document.removeEventListener("click",a),document.removeEventListener("keydown",r),o.removeEventListener("click",a)},r=e=>{"Escape"===e.key&&a()};o.addEventListener("click",a),document.addEventListener("click",a),document.addEventListener("keydown",r)},setFlag:e=>{a=e}},r()})()})();